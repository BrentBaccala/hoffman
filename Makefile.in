
HOFFMAN ?= ./hoffman

CFLAGS= @CFLAGS@ @READLINE_CPPFLAGS@ @XML_CPPFLAGS@ @CURL_CFLAGS@
CXXFLAGS= @CFLAGS@ @READLINE_CPPFLAGS@ @XML_CPPFLAGS@ @CURL_CFLAGS@

hoffman_OBJS = hoffman.o zlib_fopen.o @NALIMOVOBJS@ @CURLOBJS@ @FTPOBJS@

configure_SRCS = configure configure.in Makefile.in config.h.in config.guess config.sub install-sh
hoffman_SRCS = hoffman.cc probe.c egtb.cpp lock.h tbdecode.h url_fopen.c ftp_fopen.c zlib_fopen.c url_fopen.h ftp_fopen.h zlib_fopen.h bitlib.h
hoffman_DTD = tablebase.dtd formats.xml
hoffman_SCRIPTS = pawngen genctlfile.pl gensuicide.pl genalltb genalltb.bat hoffman.nsi md5htb cgi-bin/*
hoffman_DOCS = README COPYING ChangeLog TODO tutorial.pdf reference.pdf proptables.pdf
hoffman_DOCSRC = tutorial.tex reference.tex proptables.tex proptables-fig1.fig
hoffman_XMLS = xml/*.xml

hoffman_DIST = $(configure_SRCS) $(hoffman_SRCS) $(hoffman_DTD) $(hoffman_SCRIPTS) $(hoffman_DOCS) $(hoffman_DOCSRC) $(hoffman_XMLS)

boost_LIBS = @BOOST_THREAD_LIB@ @BOOST_FILESYSTEM_LIB@ @BOOST_SYSTEM_LIB@

hoffman: $(hoffman_OBJS)
	@LINKER@ @CFLAGS@ -o hoffman $^ @XML_LIBS@ @CURL_LIBS@ @LIBS@ $(boost_LIBS)
	echo set pagination 0 > .gdbinit
	grep -Hn BREAKPOINT *.c | cut -d : -f 1-2 | sed 's/^/break /' >> .gdbinit

hoffman.o: tablebase_dtd.h formats.h config.h bitlib.h

tablebase_dtd.h: tablebase.dtd formats.xml
	echo "const char * tablebase_dtd = \"\\" > $@
	sed -e 's/"/\\"/g' -e 's/$$/\\/' tablebase.dtd >> $@
	echo "\";" >> $@
	echo "const char * formats_xml = \"\\" >> $@
	sed -e 's/"/\\"/g' -e 's/$$/\\/' formats.xml >> $@
	echo "\";" >> $@

formats.h:
	echo "const struct format entries_format = {4,2, 8, 0xff,0,8, 0x7f,9,7, 0,-1,0, 0,-1,0, -1,FORMAT_FLAG_NONE, -1};" > $@
	echo "const struct format proptable_format = {7,16, -1, 0xffff,32,16, 0xff,56,8," >> $@
	echo "					      0xffffffff,0,32, 0xffffffffffffffffLL,64,64," >> $@
	echo "					      -1,FORMAT_FLAG_NONE, -1};" >> $@

tarball: docs
	tar -czh -f hoffman-@PACKAGE_VERSION@.tgz --transform='s|^|hoffman-@PACKAGE_VERSION@/|' $(hoffman_DIST)

ChangeLog: RCS/hoffman.c,v
	rlog hoffman.c > ChangeLog

docs: $(hoffman_DOCS)

tutorial.pdf: tutorial.tex
	latex tutorial
	dvipdf tutorial

reference.pdf: reference.tex
	latex reference
	dvipdf reference

proptables.pdf: proptables.tex proptables-fig1.eps
	latex proptables
	dvipdf proptables

proptables-fig1.eps: proptables-fig1.fig
	fig2dev -L eps proptables-fig1.fig proptables-fig1.eps

%.htb: %.xml
	$(HOFFMAN) -g -o $@ $<

# %.htb.gz: %.xml
#	./hoffman -g -o $*.htb $<
#	./hoffman -v -n Nalimov $*.htb
#	gzip $*.htb

#%.gz: %
#	gzip -f $<

kpk.htb: kqk.htb krk.htb knk.htb kbk.htb

kqkq.htb: kqk.htb

kqkr.htb: kqk.htb krk.htb
kqkn.htb: kqk.htb knk.htb
kqkb.htb: kqk.htb kbk.htb

kqkp.htb: kqkq.htb kqkr.htb kqkn.htb kqkb.htb

krkr.htb: krk.htb
krkn.htb: krk.htb knk.htb
krkb.htb: krk.htb kbk.htb

krkp.htb: kqkr.htb krkr.htb krkb.htb krkn.htb

kbkb.htb: kbk.htb
kbkn.htb: kbk.htb knk.htb

kbkp.htb: kqkb.htb krkb.htb kbkb.htb kbkn.htb

knkn.htb: knk.htb

knkp.htb: kqkn.htb krkn.htb kbkn.htb knkn.htb

kpkp.htb: kqkp.htb krkp.htb kbkp.htb knkp.htb

kqpk.htb: kqk.htb kpk.htb kqqk.htb kqrk.htb kqbk.htb kqnk.htb

krpk.htb: krk.htb kpk.htb kqrk.htb krrk.htb krnk.htb krbk.htb

kbpk.htb: kbk.htb kpk.htb kqbk.htb krbk.htb kbbk.htb kbnk.htb

knpk.htb: knk.htb kpk.htb kqnk.htb krnk.htb kbnk.htb knnk.htb

kppk.htb: kpk.htb kqpk.htb krpk.htb kbpk.htb knpk.htb
