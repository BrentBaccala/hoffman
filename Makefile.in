
HOFFMAN ?= ./hoffman

CXXFLAGS= @CXXFLAGS@ @READLINE_CPPFLAGS@ @XML_CPPFLAGS@ @CURL_CFLAGS@

hoffman_OBJS = hoffman.o zlib_fopen.o @NALIMOVOBJS@ @CURLOBJS@ @FTPOBJS@

configure_SRCS = configure configure.ac Makefile.in config.h.in config.guess config.sub install-sh
hoffman_SRCS = hoffman.cc probe.c egtb.cpp lock.h tbdecode.h url_fopen.c ftp_fopen.c zlib_fopen.c url_fopen.h ftp_fopen.h zlib_fopen.h bitlib.h
hoffman_DTD = tablebase.dtd
hoffman_SCRIPTS = pawngen genctlfile.pl gensuicide.pl genalltb genalltb.bat hoffman.nsi md5htb cgi-bin/*
hoffman_DOCS = README COPYING ChangeLog TODO tutorial.pdf reference.pdf
hoffman_DOCSRC = tutorial.tex reference.tex
hoffman_XMLS = xml/*.xml
hoffman_RCS = RCS xml/RCS

hoffman_DIST = $(configure_SRCS) $(hoffman_SRCS) $(hoffman_DTD) $(hoffman_SCRIPTS) $(hoffman_DOCS) $(hoffman_DOCSRC) $(hoffman_XMLS)

hoffman: $(hoffman_OBJS)
	@LINKER@ $(CXXFLAGS) -o hoffman $^ @XML_LIBS@ @CURL_LIBS@ @LIBS@
	echo set pagination 0 > .gdbinit
	grep -Hn BREAKPOINT *.c | cut -d : -f 1-2 | sed 's/^/break /' >> .gdbinit

hoffman.o: tablebase_dtd.h config.h bitlib.h

tablebase_dtd.h: tablebase.dtd
	echo "const char * tablebase_dtd = \"\\" > $@
	sed -e 's/"/\\"/g' -e 's/$$/\\/' tablebase.dtd >> $@
	echo "\";" >> $@

tarball: docs
	tar -czh -f hoffman.tgz --transform='s|^|hoffman-@PACKAGE_VERSION@/|' $(hoffman_DIST)
	tar -czh -f hoffman-RCS.tgz --transform='s|^|hoffman-@PACKAGE_VERSION@/|' $(hoffman_DIST) $(hoffman_RCS)

ChangeLog: RCS/hoffman.c,v
	rlog hoffman.c > ChangeLog

docs: $(hoffman_DOCS)

tutorial.pdf: tutorial.tex
	latex tutorial
	dvipdf tutorial

reference.pdf: reference.tex
	latex reference
	dvipdf reference

check-probes:
	@cat PROBES | while read md5expected input files; do						\
		if [ "$$md5expected" != "" -a "$$md5expected" != "#" ]; then				\
			echo $$input									\
				| $(HOFFMAN) -p $$files 2>&1 | tee /dev/stderr				\
				| tail -n +2								\
				| md5sum | ( read md5actual junk;					\
					if [ "$$md5expected" != "$$md5actual" ]; then			\
						echo $$md5expected != $$md5actual; exit 1;		\
					fi								\
				) || exit 1;								\
		fi;											\
	done

%.htb: %.xml
	$(HOFFMAN) -g $<

depends: *.xml
	for xmlfile in *.xml; do									\
		echo -n "$$xmlfile: " | sed 's/\.xml:/.htb:/';						\
		grep futurebase $$xmlfile | cut -d \" -f 2 | xargs;					\
	done > depends

include depends
